(function(){
	var activityTimestamp = null;
	var poller, countdown, expiredModal, countdownModal;
	var warningMessage = false;
	var POLLER_URL = "/sec/timeoutMgmt.xhtml";
	var LOGOUT_URL = "/home/logout.jsp";

	var countdownTemplate = $("\
		<div class='pccSessionTimeoutModalWrapper'>\
			<div class='pccSessionTimeoutModal'>\
				<div class='pccSessionTimeoutModalTitle'>Timeout Warning</div>\
				<div class='pccSessionTimeoutModalMsg'>\
					<p>Your session will timeout in </p>\
					<p style='font-size:24px; text-align:center;'><strong class='_pccSessionCountdown'></strong></p>\
					<p><button class='pccButton _pccSessionResume'>Stay Logged In</button> <button class='pccButton _pccSessionLogout'>Logout</button></p>\
				</div>\
			</div>\
		</div>\
	");

	var expiredTemplate = $("\
		<div class='pccSessionTimeoutModalWrapper'>\
			<div class='pccSessionTimeoutModal'>\
				<div class='pccSessionTimeoutModalTitle'>Session Timeout</div>\
				<div class='pccSessionTimeoutModalMsg'>\
					<p><strong>Your session has timed out.</strong></p>\
					<p><button class='pccButton _pccSessionLogout'>Login</button></p>\
				</div>\
			</div>\
		</div>\
	");

	function sessionLogout(){
		if(window.top != window.self){
			//trapped in an [i]frame, let the parent handle it
		} else if(typeof(window.opener) == 'object' && window.opener != null){
			window.close();//close the window if a popup
		} else {
			location.href = LOGOUT_URL;
		}
	}

	function setCountdown(ms){
		var seconds = parseInt((ms / 1000) % 60);
		var minutes = parseInt((ms / (1000 * 60)) % 60);
		//Safety catch - if values are less than 0
		if(minutes < 0){
			minutes = 0;
		}
		if(seconds < 0){
			seconds = 0;
		}
		minutes = (minutes < 10) ? "0" + minutes : minutes;
		seconds = (seconds < 10) ? "0" + seconds : seconds;
		$("._pccSessionCountdown").text(minutes + ":" + seconds);
	}

	function showSessionCountdown(timeLeftInMs){
		if(!countdownModal){
			$("body").append(countdownTemplate);
			countdownModal = countdownTemplate;
			$("._pccSessionResume").focus();
		}
		var time = timeLeftInMs;
		setCountdown(time);
		countdown = window.setInterval(function(){
			time = time - 1000;
			setCountdown(time);
		}, 1000);
	}

	function showSessionExpired(){
		$("body").append(expiredTemplate);
		expiredModal = expiredTemplate;
		logout = window.setTimeout(sessionLogout, 2000);
	}

	function clearWarningModal(){
		if(countdownModal){
			countdownModal.remove();
			countdownModal = null;
			window.clearInterval(countdown);
		}
	}
	function clearExpiredModal(){
		if(expiredModal){
			expiredModal.remove();
			expiredModal = null;
		}
	}

	function checkSessionStateResponse(response){
		if(response.timeToExpiry <= 0){
			clearWarningModal();
			showSessionExpired();
		} else if(response.timeToWarning <= 0){
			warningMessage = true;
			showSessionCountdown(response.timeToExpiry);
			poller = window.setTimeout(pollForSessionState, response.touchInterval);
		} else {
			clearWarningModal();
			clearExpiredModal();
			poller = window.setTimeout(pollForSessionState, response.touchInterval);
		}
	}

	function pollForSessionState(){
		window.clearTimeout(poller);
		var pollerParams = {};
		if(activityTimestamp != null && warningMessage == false){
			var millisecondsSinceActivity = (new Date()).getTime() - activityTimestamp.getTime();
			pollerParams = {lastActionAge: millisecondsSinceActivity};
		}
		$.get(POLLER_URL, pollerParams, checkSessionStateResponse);
	}

	function startWatcher(){
		//firstInterval set in setheader
		poller = window.setTimeout(pollForSessionState, firstInterval);
		window.addEventListener("mousemove", function(){
			activityTimestamp = new Date();
		});

		window.addEventListener("keydown", function(){
			activityTimestamp = new Date();
		});

		$(document).on("click", "._pccSessionResume", function(){
			activityTimestamp = new Date();
			$(".pccSessionTimeoutModalWrapper").remove();
			warningMessage = false;
			pollForSessionState();
		});
		$(document).on("click", "._pccSessionLogout", function(){
			sessionLogout();
		});
	}

	if(self == top){
		startWatcher();
	}
}());