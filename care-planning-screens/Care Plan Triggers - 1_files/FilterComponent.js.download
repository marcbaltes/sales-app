'use strict';

(function(){
	window.clinicalSmartAlerts = window.clinicalSmartAlerts || {};
	var _NS = clinicalSmartAlerts;

	_NS.FilterComponent = function(store, selector, alertsLoader) {
		_NS.StatefulComponent.call(this, { store:store, selector: selector });
		this.unitsFilter = null;
		this.floorsFilter = null;
		this._getData();
		this._dropdownHandler = this._dropdownHandler.bind(this);
		this._alertsLoader = alertsLoader;
	};
	
	_NS.FilterComponent.prototype = Object.create(_NS.StatefulComponent.prototype);
	_NS.FilterComponent.prototype.constructor = _NS.FilterComponent;
	_NS.FilterComponent.prototype._getData = function() {
		var state = this.store.getState(),
			data = state.unitsAndFloors.data;
		
		if (!data || data.facId !== state.facId) {
			this.store.dispatch({
				type: 'CLEAR_FILTER_DATA'
			});
			
			$.getJSON('/clinical/alerts/smart/getunitsandfloors.xhtml')
				.done(function(data) {
					this.store.dispatch({
						type: 'UPDATE_FILTER_DATA',
						payload: data
					});
				}.bind(this));
		}
	};
	_NS.FilterComponent.prototype._dropdownHandler = function (type, id, label) {
		this.store.dispatch({
			type: 'UPDATE_FILTER_DROPDOWN',
			payload: {
				type: type,
				id: id,
				label: label
			}
		});
		this.store.dispatch({ type: 'CLEAR_SCROLLED_TO_ALERT' });
		this.store.dispatch({ type: 'CLEAR_ALL_ACTIVE_ALERTS' });
		this.store.dispatch({
			type: 'LOAD_ALERTS_INITIALIZE',
			payload: {
				doReplaceExistingAlerts: true,
				isGettingOlderAlerts: true
			}
		});
		this._alertsLoader.loadAlerts();
	};
	_NS.FilterComponent.prototype.render = function() {
		var state = this.store.getState(),
			obj = {},
			unitSelected = state.unitsAndFloors.unitSelected,
			floorSelected = state.unitsAndFloors.floorSelected,
			unitAndFloorsData = state.unitsAndFloors.data,
			CLASS_HIDDEN = 'u-hidden';
				
		if (state.alerts.type === 'client' || !unitAndFloorsData) {
			$(this.element).addClass(CLASS_HIDDEN);
			return;
		} else {
			$(this.element).removeClass(CLASS_HIDDEN);
		}
		
		if (state.isLoading) {
			$(this.element).css('opacity', 0.5).on('click.stopPropagation', function(e){
				e.stopPropagation();
			});
		} else {
			$(this.element).css('opacity', 1).off('click.stopPropagation');
		}
		
		if (state.facId !== unitAndFloorsData.facId || !this.unitsFilter || !this.floorsFilter) {
			this.unitsFilter = new _NS.DropdownComponent('.js-clinical-smart-alerts .js-dropdown-unit', unitAndFloorsData.units, this._dropdownHandler);
			this.floorsFilter = new _NS.DropdownComponent('.js-clinical-smart-alerts .js-dropdown-floor', unitAndFloorsData.floors, this._dropdownHandler);
			
			if(_NS.moduleProps.isNewLogin === true)
			{
				if (unitAndFloorsData.sessionDefaultUnitDesc != null)
				{
					this.unitsFilter.setValue(unitAndFloorsData.sessionDefaultUnitId, unitAndFloorsData.sessionDefaultUnitDesc);
					this.store.dispatch({
						type: 'UPDATE_FILTER_DROPDOWN',
						payload: {
							type: 'unit',
							id: unitAndFloorsData.sessionDefaultUnitId,
							label: unitAndFloorsData.sessionDefaultUnitDesc
						}
					});
				}
				if (unitAndFloorsData.sessionDefaultFloorDesc != null)
				{
					this.floorsFilter.setValue(unitAndFloorsData.sessionDefaultFloorId, unitAndFloorsData.sessionDefaultFloorDesc);
					this.store.dispatch({
						type: 'UPDATE_FILTER_DROPDOWN',
						payload: {
							type: 'floor',
							id: unitAndFloorsData.sessionDefaultFloorId,
							label: unitAndFloorsData.sessionDefaultFloorDesc
						}
					});
				}				
			}
			else
			{
				if (unitSelected) this.unitsFilter.setValue(unitSelected.id, unitSelected.label);
				if (floorSelected) this.floorsFilter.setValue(floorSelected.id, floorSelected.label);
			}
		}
	};
}());