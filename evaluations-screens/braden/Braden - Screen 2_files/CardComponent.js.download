'use strict';

(function(){
	window.clinicalSmartAlerts = window.clinicalSmartAlerts || {};
	var _NS = clinicalSmartAlerts;
		
	_NS.CardComponent = function(store, element, clearAlertCardCallback) {
		this.smartAlertSaveActionVOFactory = _NS.SmartAlertSaveActionVOFactory;

		_NS.StatefulComponent.call(this, { store:store, selector: element.id });
		this.element = element;
		this._clearAlertCardCallback = clearAlertCardCallback;
		this._flipElement = $(this.element).find('.flipcard');
		this._graphElement = $(this.element).find('.trendgraph');
		this._tableElement = $(this.element).find('.js-alert-details-table');
		this._disabled = false;
		this._graphData = undefined;
		this._GRAPH_LOADER = 'js-graph-loader c-loader c-loader--center';

		this._suggestionsSubComponent = new _NS.SuggestionsSubComponent(store, '#' + element.id + ' div.js-show-hide.js-card-expander.c-show-hide.c-card-expander', this);
		this._pnComponent = new _NS.ProgressNoteSubComponent(store, '#' + element.id + ' .js-pn-interactive-section', this);
		
		if (_NS.moduleProps.canAddPN && _NS.moduleProps.isESignatureForPNEnabled) {
			this._eSignatureCarousel = new _NS.Carousel(this.element.querySelector('.js-carousel-esignature'));
		}

		this._initHandlers();
		if (_NS.Cards) {
			_NS.Cards.set(this.element.id, this);
		}

		this._suggestionsSubComponent.toggleSaveCancelButtons(false);
	};

	_NS.CardComponent.prototype = Object.create(_NS.StatefulComponent.prototype);
	_NS.CardComponent.prototype.constructor = _NS.CardComponent;
    
	_NS.CardComponent.prototype._performMultiSave = function(clickedButton) {
		var _self = this;
		var element = $(_self.element);
		var alertType;
		var wvType;

		var smartAlertSaveActionVOs = _self._suggestionsSubComponent.getSmartAlertActionVOs();
		var voList = [];
		if(smartAlertSaveActionVOs.progressNoteSaveActionVO) {
			alertType = smartAlertSaveActionVOs.progressNoteSaveActionVO.alerts.type;
			wvType = smartAlertSaveActionVOs.progressNoteSaveActionVO.progressNote.wvType;
			voList.push(smartAlertSaveActionVOs.progressNoteSaveActionVO);
		}
		if(smartAlertSaveActionVOs.eInteractAssessmentSaveActionVO) {
		  voList.push(smartAlertSaveActionVOs.eInteractAssessmentSaveActionVO);
		}
		if(smartAlertSaveActionVOs.carePlanItemVOs != null && smartAlertSaveActionVOs.carePlanItemVOs.length > 0) {
		  Array.prototype.push.apply(voList, smartAlertSaveActionVOs.carePlanItemVOs);
		}

		_self._disableInputsAndButtons(_self.element, clickedButton);
		$.ajax({
			url: '/clinical/alerts/smart/saveActions.xhtml',
			data: JSON.stringify(voList),
			dataType: 'json',
			type: 'POST',
			contentType: 'application/json',
			success: function(data, textStatus, jqXHR) {
				for(var i = 0; i < data.length; i++) {
					if(data[i].createProgressNote != null) {
						var pnId = data[i].createProgressNote.pnId;
						if(pnId) {
							_self._pnComponent._resetPN();
							if(_NS.moduleProps.isESignatureForPNEnabled) {

								_self._eSignatureCarousel.previous(function(){
									$(':focus').blur();
									element
									.find('.js-input-esignature-password').removeClass('has-error').val('');
								});
								_self._resetFormStatusMessage('.js-esignature-form-status-msg');
							}
							element.find('.js-create-pn-wrapper').removeClass('c-show-hide--is-active');
							if (element.data('clearAlertPermission') === true) {
								_self._clearFromUI();
							} else {
								var pnJSON = _self._getPnStructureFromCache(alertType, wvType, pnId);
								if (pnJSON) {
									var json = JSON.parse(pnJSON);
									json.forEach(function(pn) {pn.pnId=pnId;});
									_self._putPnStructureInCache(alertType, wvType, pnId, JSON.stringify(json));
								}
								else {
									$.getJSON('/clinical/alerts/smart/getpnsectiontext.xhtml', {
										alertType: alertType,
										wvType: wvType,
										pnId: pnId
									})
									.success(function(data) {
										if (data && data.length >0) {
											_self._putPnStructureInCache(alertType, wvType, data[0].pnId, JSON.stringify(data));
										}
									}.bind(this));
								}
								_self._pnComponent._updatePNSection(pnId);
							}
							_self._enableInputsAndButtonsWhereAppropriate(_self.element, clickedButton, _self.element);
							_self._disableInputsAndButtons($(_self.element).find('.js-pn-interactive-section'), clickedButton);

							_self.store.dispatch({
								type: 'CREATE_PROGRESS_NOTE_COMPLETE',
								payload: {
									id: element.data('alertId'),
									type: element.data('alertType')
								}
							});
						}
						else {
							_self._pnComponent._createPNFailCallback(clickedButton);
						}
					} else if(data[i].createEInteractAssessment != null) {
						var assessId = data[i].createEInteractAssessment.assessId;

						_self._enableInputsAndButtonsWhereAppropriate(_self.element, clickedButton, _self.element);
						// close checkbox and disable
						var wrapper = element.find('div.js-assessment-create-wrapper');
						wrapper.removeClass('c-show-hide--is-active');
						if (assessId) {
						  wrapper.children('label.c-custom-checkbox')
								.removeClass('c-custom-checkbox')
								.addClass('c-custom-checkbox__disabled')
								.children('input').prop('disabled', true);
								element.attr('data-assessment-linked', 'true');
						}
					}
					_self._suggestionsSubComponent.toggleSaveCancelButtons(false);
				}
				},
				error: function( jqXHR, textStatus, errorThrown ) {
					_self._pnComponent._createPNFailCallback(clickedButton);
				}
		});
	};
	
	_NS.CardComponent.prototype._clearAlert = function(alertId, groupedAlertIds, alertType, module) {
		var _self = this;
		$.post('/clinical/alerts/smart/clearalert.xhtml', {
			alertId: alertId,
			alertType : alertType,
			groupedAlertIds : groupedAlertIds || '',
			module : module
			})
		.success(function(data, textStatus, jqXhr){
			_self._clearFromUI();
			_self.store.dispatch({
				type: 'CLEAR_COMPLETE',
				payload: {
					id: alertId,
					type: alertType,
				}
			});
		})
		.fail(function(data, textStatus, jqXhr) {
			//Todo: figure out what to do for failing situation
			_self.store.dispatch({
				type: 'CLEAR_COMPLETE',
				payload: {
					id: alertId,
					type: alertType,
				}
			});
		});
	};
    
	_NS.CardComponent.prototype._getPnKey = function(alertType, wvType, pnId) {
		return _NS.AppStorage.PN_PREFIX + alertType + '#' + wvType + '#' + pnId;
	}

	_NS.CardComponent.prototype._putPnStructureInCache = function(alertType, wvType, pnId, data) {
		return _NS.AppStorage.set(this._getPnKey(alertType, wvType, pnId), data);
	};

	_NS.CardComponent.prototype._getPnStructureFromCache = function(alertType, wvType, pnId) {
		return _NS.AppStorage.get(this._getPnKey(alertType, wvType, pnId));
	};

	_NS.CardComponent.prototype._removePnStructureFromCache = function(alertType, wvType, pnId) {
		return _NS.AppStorage.remove(this._getPnKey(alertType, wvType, pnId));
	};
	
	_NS.CardComponent.prototype._initHandlers = function() {
		var _self = this;
		
		if (_NS.moduleProps.canAddPN) {
			var element = $(_self.element);
			element
				.on('click.saveInteractiveSection', '.js-button-save-interactive-suggestions', function(e) {

					if(_self._suggestionsSubComponent.isCreateAssessmentActive() && !_self._suggestionsSubComponent.validateEffectiveDate()) {
						return;
					}
					
					if (_NS.moduleProps.isESignatureForPNEnabled && _self._suggestionsSubComponent.isCreatePNActive()) {
						_self._eSignatureCarousel.next(function() {
							$(':focus').blur();
							$(_self.element).find('.js-input-esignature-password').focus();
						});
					} else {
						_self._performMultiSave(this);
					}
					_self._recordSuggestionsEvent(element, 'Save Smart Alert Interactive Section');
				})
				.on('click.cancelInteractiveSection', '.js-button-cancel-interactive-suggestions', function(e) {
					_self._pnComponent._resetPN();
					_self._resetAssessment();
					_self._suggestionsSubComponent.uncheckAll();
					_self._suggestionsSubComponent.toggleSaveCancelButtons(false);
					_self._recordSuggestionsEvent(element, 'Cancel Smart Alert Interactive Section');
				})
				.on('click','.smart-alert-card-link,input[type=checkbox], .c-card-expander, .c-more-less__btn, .flipcard-chevron-container' , function(e) {
					// Save this as the "scrolled alert" when clicking link so we will keep the alert in view
					// Trick the code into thinking it is the same tab by setting 
					// the appropriate tab type
					var clientId = element.data('clientId');
					var tabType = 'client';
					if (_NS.AppStorage.get(_NS.AppStorage.FORCE_ALL) === clientId)
						tabType = 'all';
					_self.store.dispatch({
						type: 'SAVE_SCROLLED_TO_ALERT',
						payload: {
							alertId: element.data('alertId'),
							alertType: element.data('alertType'),
							clientId: element.data('clientId'),
							createdTimestamp: element.data('createdTimestamp'),
							tabType : tabType,
						}
					});

					if($(this).hasClass('smart-alert-card-link')) {
						_self._recordSuggestionsEvent(element, this.text);
					}
				})
				.on('change.createPN', 'div.js-create-pn-wrapper input', function(e) {
					if($(this).prop('checked')) {
						var alertType = element.data('alertType');
						var wvType = element.data('vitalType');
						var pnId = element.attr('data-pn-id');
						var pnJSON = _self._getPnStructureFromCache(alertType, wvType, pnId);
						if (pnJSON) {
							_self._pnComponent._setupProgressNote(JSON.parse(pnJSON));
						} else {
							$.getJSON('/clinical/alerts/smart/getpnsectiontext.xhtml', {
								alertType: alertType,
								wvType: wvType,
								pnId: pnId
							})
							.success(function(data) {
								_self._pnComponent._setupProgressNote(data);
								_self._putPnStructureInCache(alertType, wvType, pnId, JSON.stringify(data));
							}.bind(this));
						}
						_self._recordSuggestionsEvent(element, 'Add Progress Note');
					} else {
						_self._pnComponent._resetPN();	
					}
				});
		}
		
		if (_NS.moduleProps.canAddPN && _NS.moduleProps.isESignatureForPNEnabled) {
			var element = $(_self.element);
			element
				.on('click.signESign', '.js-button-sign-esignature', function(e) {
				  var clickedButton = this;
					if(_self._suggestionsSubComponent.isCreateAssessmentActive() && !_self._suggestionsSubComponent.validateEffectiveDate()) {
						return;
					}

					var passwordInput = $(_self.element).find('.js-input-esignature-password');
					_self._resetFormStatusMessage('.js-esignature-form-status-msg');
					if(_self._validateInput(passwordInput, true)) {
					  _self._disableInputsAndButtons(_self.element, clickedButton);
						$.post('/clinical/alerts/smart/verifyelectronicsignature.xhtml', {
							token: passwordInput.val()
						})
						.success(function(data, textStatus, jqXhr) {
						  // enable inputs because _performMultiSave reads data from enabled inputs only
						  _self._enableInputsAndButtonsWhereAppropriate(_self.element, clickedButton, _self.element);
							_self._performMultiSave(clickedButton);
						})
						.fail(function(jqXhr, textStatus, error) {
							_self._inputShowError(passwordInput);
							_self._setFormStatusMessage('.js-esignature-form-status-msg', jqXhr.responseText, true);
							_self._enableInputsAndButtonsWhereAppropriate(_self.element, clickedButton, _self.element);
						}.bind(this));
					}
				})
				.on('click.cancelESign', '.js-button-cancel-esignature', function(e) {
					_self._eSignatureCarousel.previous(function() {
						$(':focus').blur();
						element
							.find('.js-input-esignature-password').removeClass('has-error').val('');
					});
					_self._resetFormStatusMessage('.js-esignature-form-status-msg');
				})
				.on('keypress.keyPressESign', '.js-esignature-form', function(e){
					if (e.which === 13) {
						element.find('.js-button-sign-esignature').trigger('click.signESign');
						e.preventDefault();
					}
				});
		}

		if (_NS.moduleProps.canAssessAlerts && _NS.moduleProps.isCICOnline) {
			var element = $(_self.element);
			$(element)
			.on('change.setupAssess', 'div.js-assessment-create-wrapper > label > input', function(e) {
				var element = $(_self.element);
				var dateField = element.find('input.pccDateField');
				// initialize date picker
				var hiddenInput = element.find('input[name="effective_date"]');
				var curDate = new Date();
				hiddenInput.attr('value', (curDate.getMonth() + 1) + '/' + curDate.getDate() + '/' + curDate.getFullYear());
				dateField.attr('value', (curDate.getMonth()) + 1 + '/' + curDate.getDate() + '/' + curDate.getFullYear());
				element.find('select[name=hour]').val(curDate.getHours());
				element.find('select[name=min]').val(curDate.getMinutes());

				if(!dateField.hasClass('hasDatepicker')) {
					element.find('button').prop('disabled', true);
					dateField.dateField();
					$.getJSON('/clinical/alerts/smart/getCICReasons.xhtml', {
						alertType : element.data('alertType'),
						alertIds : element.data('groupedAlertIds')
					})
					.success(function(data, textStatus, jqXhr) {
						if(data.stopWatchAlertDesc != null && data.stopWatchAlertDesc.length != 0) {
							element.attr('data-stop-and-watch-alert-descs', JSON.stringify(data.stopWatchAlertDesc));
							var SWspan = element.find('.alert-SW-conds');
							SWspan.after(' ' + data.stopWatchAlertDesc.join('; '));
						}

						// the multi-select uses the chosen library (https://github.com/harvesthq/chosen)
						var select = element.find('.chzn-select');
						for(var i in data.reasons) {
							var option = document.createElement('option');
							option.setAttribute('value', data.reasons[i].item_value);
							option.textContent = data.reasons[i].item_description;

							if(data.alertReasonIds.indexOf(data.reasons[i].item_value) >= 0) {
								option.setAttribute('selected', 'selected');
							}
							select.append(option);
						}

						_self._toggleOtherChangeinConditionTextBox();

						/* show multi-select after data is loaded
							unhiding must happen before chosen is called because jquery can't find element width
							when it's hidden */
						element.find(".c-einteract-assessment__hidden").removeClass("c-einteract-assessment__hidden");
						// initialize multi-select with 'chosen' library
						$(select).chosen();

						element.find('button').prop('disabled', false);
					})
					.fail(function(jqXhr, textStatus, error) {
						element.find('button').prop('disabled', false);
					}.bind(this));
				}
			})
			.on('change.toggle"OtherChangeInCondition"textbox', ".chzn-select", function(e) {
				_self._toggleOtherChangeinConditionTextBox();
			})
		}
		
		$(this.element)
			.on('click.clearAlert', '.js-alert-card-clear', function(e) {
				var element = $(_self.element);
				if(_self.store.getState().isLoading) return;
				_self._clearAlert(
						element.data('alertId'),
						element.data('groupedAlertIds'),
						element.data('alertType'),
						element.data('module')
				);				
				_self._recordCardEvent(element,'Clear');
			})
			.on('click.saveCardExpanderStatus', '.js-card-expander-toggle', function(e) {
				var element = $(_self.element);
				setTimeout(function(){
					if ($(this).closest('.js-show-hide').hasClass('c-show-hide--is-active')) {
						_self.store.dispatch({
							type: 'SAVE_ACTIVE_ALERT',
							payload: {
								alertId: element.data('alertId'),
								alertType: element.data('alertType'),
								isCardExpanded: true
							}
						});	
					} else {
						_self.store.dispatch({ 
							type: 'CLEAR_ACTIVE_ALERT',
							payload: {
								alertId: element.data('alertId'),
								alertType: element.data('alertType')
							}
						});	
					}
				}.bind(this), 10);
				_self._recordCardEvent(element,'Expand');
			})
			.on('click.saveAlertDetailsExpanderStatus', '.js-alert-details-expander-toggle', function(e) {
				var element = $(_self.element);
				setTimeout(function(){
					if ($(this).closest('.js-show-hide').hasClass('c-show-hide--is-active')) {
						_self.store.dispatch({
							type: 'SAVE_ACTIVE_ALERT',
							payload: {
								alertId: element.data('alertId'),
								alertType: element.data('alertType'),
								isCardExpanded: true,
								isDetailsExpanded: true,
								isGraphShown: true // meaning chart is shown
							}
						});
						if (!_self._graphData) {
							_self._loadGraph();
						}
					} else {
						_self.store.dispatch({
							type: 'SAVE_ACTIVE_ALERT',
							payload: {
								alertId: element.data('alertId'),
								alertType: element.data('alertType'),
								isCardExpanded: true,
								isDetailsExpanded: false,
								isGraphShown : true
							}
						});
						_self.selectFlipCard(true);
						_self.store.dispatch({ type: 'LOAD_ALERT_GRAPH_COMPLETE'});
					}
				}.bind(this), 10);
				_self._recordCardEvent(element,'Alert Details');
			})
			.on('click.flipCard', '.flipcard-chevron-container', function() {
				var element = $(_self.element);
				var isGraphShown = element.find('.flipcard-side-front').hasClass('flipcard-is-active');
				_self._flipCards();
				setTimeout(function(){
					_self.store.dispatch({
						type: 'SAVE_ACTIVE_ALERT',
						payload: {
							alertId: element.data('alertId'),
							alertType: element.data('alertType'),
							isCardExpanded: true,
							isDetailsExpanded: true,
							isGraphShown: !isGraphShown
						}
					});
					if (!_self._graphData) {
						_self._loadGraph();
					}
				}.bind(this), 10);
				_self._recordCardEvent(element,'Alert List View');
				return false;
			})
	};

	_NS.CardComponent.prototype._toggleOtherChangeinConditionTextBox = function() {
		var select = $(this.element).find('.chzn-select');
		if(select.val() != null && select.val().indexOf(_NS.moduleProps.cicOtherCICReasonId) >= 0) {
			$(this.element).find('.c-cic-other-symptoms').removeClass('u-hidden');
		}
		else {
			$(this.element).find('.c-cic-other-symptoms').addClass('u-hidden');
		}
	}
	
	_NS.CardComponent.prototype._recordEvent = function(e, category, action) {
		var cardCat = e.find(".c-card__type").text();
		_NS.sendEventIfEnabled(category, action, cardCat);
	};

	_NS.CardComponent.prototype._recordCardEvent = function(e, action) {
		this._recordEvent(e,'Card', action);
	};

	_NS.CardComponent.prototype._recordSuggestionsEvent = function(e, action) {
		this._recordEvent(e,'Suggestions', action);
	};

	_NS.CardComponent.prototype._inputHasError = function(target) {
		if (!$(target).val().trim()) return true;
	};
	
	_NS.CardComponent.prototype._inputShowError = function(target) {
		$(target).addClass('has-error');
	};
	
	_NS.CardComponent.prototype._inputRemoveError = function(target) {
		$(target).removeClass('has-error');
	};	
	
	_NS.CardComponent.prototype._validateInput = function(jqInput, doFocus) {
		var doFocus = typeof doFocus === 'undefined' ? false : true;
		if (this._inputHasError(jqInput)) {
			this._inputShowError(jqInput);
			if(doFocus) jqInput.focus();
			return false;
		}
		this._inputRemoveError(jqInput);
		return true;
	}

	_NS.CardComponent.prototype._resetAssessment = function() {
		var _self = this;
		var element = $(_self.element);
		if(element.attr('data-assessment-linked') === 'false') {
			element.find('div.js-assessment-create-wrapper')
			.removeClass('c-show-hide--is-active')
			.find('label > input')
			  .prop('checked', false)
			  .end();
		}
	}
	
	_NS.CardComponent.prototype._clearFromUI = function() {
		var card = this.element,
			alertId = $(card).data('alertId'),
			alertType = $(card).data('alertType'),
			transitionEndEventName = _NS.Polyfill.tools.getTransitionEndEvent();
		
		if($(card).data('disabled')) return;
		
		$(card)
			.data('disabled', true)
			.addClass('u-transition-scale-down-bounce');
		
		this._transitionHeightToZero();
		
		if (!transitionEndEventName){
			if (_NS.Cards) {
				_NS.Cards.delete(this.element.id);
			}
			$(card).remove();
			this._clearAlertCardCallback(alertId, alertType);
			return;
		}
		
		$(card).one(transitionEndEventName, function(e){
			if (_NS.Cards) {
				_NS.Cards.delete(this.element.id);
			}
			$(card).remove();
			this._clearAlertCardCallback(alertId, alertType);
		}.bind(this));
	};
	
	_NS.CardComponent.prototype._transitionHeightToZero = function() {
		var sectionHeight = this.element.scrollHeight;
		
		var elementTransition = this.element.style.transition;
		this.element.style.transition = '';

		requestAnimationFrame(function() {
			this.element.style.height = sectionHeight + 'px';
			this.element.style.transition = elementTransition;
			
			requestAnimationFrame(function() {
				this.element.style.height = 0 + 'px';
			}.bind(this));
	    }.bind(this));
	};
	
	_NS.CardComponent.prototype.getAlertId = function() {
		return $(this.element).data('alertId');
	};
	
	_NS.CardComponent.prototype.getAlertType = function() {
		return $(this.element).data('alertType');
	};
	
	_NS.CardComponent.prototype.expandCard = function() {
		$(this.element).find('.js-card-expander').addClass('c-show-hide--is-active');
	};
	
	_NS.CardComponent.prototype.expandAlertDetails = function() {
		$(this.element).find('.js-alert-details-expander').addClass('c-show-hide--is-active');
		this._loadGraph();
	};
	
	_NS.CardComponent.prototype._setFormStatusMessage = function(selector, text, hasError) {
		var hasError = typeof hasError !== 'undefined' ? hasError : false;
		$(this.element).find(selector)
			.toggleClass('c-form__status-msg--has-error', hasError)
			.text(text);
	};
	
	_NS.CardComponent.prototype._resetFormStatusMessage = function(selector) {
		$(this.element).find(selector)
			.removeClass('c-form__status-msg--has-error')
			.empty();
	};

	_NS.CardComponent.prototype._disableInputsAndButtons = function(parentElement, focusedElement) {
		this._disabled = true;
		$(parentElement)
			.find('input').prop('disabled', true)
			.end()
			.find('textarea').prop('disabled', true)
			.end()
			.find('button').prop('disabled', true)
			.end()
			.find('select').prop('disabled', true)
			.end()
			.find('option').prop('disabled', true)
			.end()
			.find('.chzn-drop').hide()
			.end()
			.find('label.c-custom-checkbox')
			.removeClass('c-custom-checkbox')
			.addClass('c-custom-checkbox__disabled')
			.end();

		if(focusedElement) {
			$(focusedElement).addClass('c-button--has-loader');
		}
	};
	
	_NS.CardComponent.prototype._enableInputsAndButtonsWhereAppropriate = function(parentElement, focusedElement, card) {

		$(focusedElement).removeClass('c-button--has-loader');
		this._disabled = false;
		$(parentElement)
			.find('input').prop('disabled', false)
			.end()
			.find('textarea').prop('disabled', false)
			.end()
			.find('button').prop('disabled', false)
			.end()
			.find('select').prop('disabled', false)
			.end()
			.find('option').prop('disabled', false)
			.end()
			.find('.chzn-drop').show()
			.end()
			.find('label.c-custom-checkbox__disabled')
			.removeClass('c-custom-checkbox__disabled')
			.addClass('c-custom-checkbox');

		// Some items should be permanently disabled (in which case no buttons should be disabled)
		if($(card).attr('data-assessment-linked') == 'true') {
			this._disableInputsAndButtons($(card).find('.js-assessment-create-wrapper')/*, undefined*/);
		}
	};
	
	_NS.CardComponent.prototype.render = function() {}

	_NS.CardComponent.prototype._showGraphLoading = function() {
		this._flipElement.addClass(this._GRAPH_LOADER);
	}

	_NS.CardComponent.prototype._hideGraphLoading = function() {
		this._flipElement.removeClass(this._GRAPH_LOADER);
	}

	_NS.CardComponent.prototype._renderGraph = function(data) {
		this._graphData = data;
		var vitalType = $(this.element).data('vitalType'),
			chartOpts,
			baseLineOpts = [],
			localChartOpts = {},
			maxValue = -99999,
			minValue = 99999;

		if (vitalType >= 0 && vitalType < _NS.moduleProps.chartOpts.length) {
			localChartOpts = _NS.moduleProps.chartOpts[vitalType];
		}

		chartOpts = $.extend(true, {}, localChartOpts, _NS.moduleProps.defaultChartOpts);
		
		if (data.baseline) {
			baseLineOpts.push.apply(baseLineOpts, [{
			    value : data.baseline,
			    class: 'pccChartBaselineSystolic'}, 
				{ value : data.baseline, 
				text : vitalType === 3 ? _NS.moduleProps.termMap.systolicBaseline : _NS.moduleProps.termMap.baseline,
				position : 'start',
				class: 'pccChartBaselineSystolic',
			}]);
			maxValue = Math.max(maxValue, data.baseline);
			minValue = Math.min(minValue, data.baseline);
		}

		if (data.diastolicBaseline) { // Should only be true when vitalType === 3 (Blood Pressure)
			baseLineOpts.push.apply(baseLineOpts, [{
			    value : data.diastolicBaseline,
			    class: 'pccChartBaselineDiastolic'},
				{ value : data.diastolicBaseline,
				text : _NS.moduleProps.termMap.diastolicBaseline,
				position : 'start',
				class: 'pccChartBaselineDiastolic',
			}]);
			maxValue = Math.max(maxValue, data.diastolicBaseline);
			minValue = Math.min(minValue, data.diastolicBaseline);			
		}

		data.vitalList.forEach(function(elem) {
			chartOpts.data.columns[0].push(elem.value);
			maxValue = Math.max(maxValue, elem.value);
			minValue = Math.min(minValue, elem.value);
			if (vitalType === 3) {
				 // Blood pressure also has the dystolicValue
				chartOpts.data.columns[1].push(elem.diastolicValue);
				maxValue = Math.max(maxValue, elem.diastolicValue);
				minValue = Math.min(minValue, elem.diastolicValue);				
			}
		});

		chartOpts.axis.y = {
				min : minValue,
				max : maxValue,
		};

		if (!this._chart) {
			this._chart = this._graphElement.pccGenerateChart(chartOpts, _NS.moduleProps.termMap.trend, undefined, '');
			this._createTable(data, vitalType);
		}

		// Need to remove inline position style - it conflicts with the chart-flipping style
		$(this.element).find('.pccChartWrapper').css('position', '');

		this._chart.load({columns : chartOpts.data.columns});

		if (baseLineOpts.length > 0) {
			this._chart.ygrids(baseLineOpts);
		}

		// Wait until the chart gets fully rendered
		// to resize 
		var _self = this
		setTimeout(function() {
			_self._resizeChart();
		}, 500);
	};

	_NS.CardComponent.prototype._createTable = function(data, vitalType) {
		var tableOptions = _NS.moduleProps.chartOpts[vitalType].data;
		var tableBody = $(this.element).find('.js-alert-details-table').find('tbody');
		var tableHeaderRow = document.createElement('tr');

		tableHeaderRow.appendChild(document.createElement('th')); // Empty Header
		for(var i = 0; i < tableOptions.columns.length; i++) {
			var headerColumn = document.createElement('th');
			headerColumn.textContent = tableOptions.columns[i][0];
			tableHeaderRow.appendChild(headerColumn);
		}
		for(var i = 0; i < data.vitalList.length && i < _NS.moduleProps.maxVitalsInChart; i++) {
			var row = document.createElement('tr');
			var rowDate = document.createElement('td');
			var rowDateValue = new Date(data.vitalList[i].date);
			var minutes = (rowDateValue.getMinutes() < 10) ? '0' + rowDateValue.getMinutes() : rowDateValue.getMinutes();
			rowDate.textContent = _NS.moduleProps.months[rowDateValue.getMonth()] + ' ' + rowDateValue.getDate() + ' ' + rowDateValue.getHours() + ':' + minutes;
			row.appendChild(rowDate);

			for(var j = 0; j < tableOptions.columns.length; j++) {
				// Blood Pressure/Respiration/Pain Level is integer, everything else is float
				var rowVitalData = (_NS.moduleProps.chartOpts[vitalType].isInteger === true) ? parseInt(data.vitalList[i][tableOptions.columnKeys[j]], 10) : data.vitalList[i][tableOptions.columnKeys[j]];

				var tempColumn = document.createElement('td');

				if(data.vitalList[i].warning != null && 0 < data.vitalList[i].warning.length) {
					// Only show warning for diastolic values
					if(tableOptions.columnKeys[j] === _NS.moduleProps.chartOpts[vitalType].data.columnKeys[_NS.moduleProps.chartOpts[vitalType].data.columnKeys.length - 1]) {
						$(tempColumn).addClass('has-error');
						var warningImage = document.createElement('img');
						$(warningImage).attr('src', '/images/clinical/wv_warning.png');
						tempColumn.appendChild(warningImage);

						var warningLabel = document.createElement('div');
						warningLabel.textContent = rowVitalData;
						$(tempColumn).prepend(warningLabel);
					} else {
						tempColumn.textContent = rowVitalData;
					}
				} else {
					tempColumn.textContent = rowVitalData;
				}				
				row.appendChild(tempColumn);
			}
			
			if(i % 2 === 0) {
				$(row).addClass('highlighted-row');
			}
			tableBody.prepend(row);
		}
		tableBody.prepend(tableHeaderRow);
	}

	_NS.CardComponent.prototype._loadGraph = function() {
		var _self = this;
		var element = $(_self.element);
		var vitalType = element.data('vitalType');

		// vitalType of -1 indicates it's not vital alert
		if(vitalType >= 0) {
			element.find('.flipcard-container').removeClass('c-hidden');
			_self._showGraphLoading();
			// Cannot dispatch an event here because
			// We will cause an infinite loop when restore
			// alert status expanded state
			$.getJSON('/clinical/alerts/smart/getwvhistory.xhtml', {
				clientId : element.data('clientId'),
				wvType : vitalType
			})
			.done(function (data) {
				_self._hideGraphLoading();
				_self._renderGraph(data);
				_self.store.dispatch({ type: 'LOAD_ALERT_GRAPH_COMPLETE'});
			})
			.fail(function (data) {
				_self._hideGraphLoading();
				_self.store.dispatch({ type: 'LOAD_ALERT_GRAPH_COMPLETE'});
			});
		}
	};
	
	_NS.CardComponent.prototype._resizeChart = function() {
		this._chart.resize({ height: _NS.moduleProps.defaultChartOpts.size.height});
	}

	_NS.CardComponent.prototype._flipCards = function() {
		var _self = this;
		var container = $(this.element).find('.flipcard');
		var sides = container.find('.flipcard-side');
		var chartWrapper = $(this.element).find('.pccChartWrapper')
		var svg = chartWrapper.find('svg');

		container.toggleClass('flipcard-is-switched');

		window.setTimeout(function() {
			sides.toggleClass('flipcard-is-active');
			// Trigger the back-side of the card to not
			// display so the card doesn't show through on IE 11
			// I do it roughly 1/2 way through the rotation.
			sides.toggleClass('c-hidden');
		}, 200);

		window.setTimeout(function() {
			if (chartWrapper.width() > 0 && chartWrapper.width() !== svg.width()) {
				// IE doesn't compute the SVG chart width correctly and makes
				// it too big, overflowing the boundary. Force the width to its
				// parent. Make sure we check the size after the card has fully
				// animated into view.
				svg.width(chartWrapper.width());
				_self._resizeChart();
			}
		}, 501);
	}

	_NS.CardComponent.prototype.selectFlipCard = function(isFrontShown) {
		var container = $(this.element).find('.flipcard');
		var front = container.find('.flipcard-side-front');
		var back = container.find('.flipcard-side-back');
		var temp;

		if (isFrontShown === false) {
			// The code below makes the front card show
			// if we flip front and back then it will make the back show
			temp = front;
			front = back;
			back = temp;
		}

		front.removeClass('c-hidden');
		// Reset the cards to be showing the correct side
		if (isFrontShown === true)
			container.removeClass('flipcard-is-switched');
		else if (!container.hasClass('flipcard-is-switched'))
			container.addClass('flipcard-is-switched');

		if (!front.hasClass('flipcard-is-active'))
			front.addClass('flipcard-is-active')

		back.removeClass('flipcard-is-active');

		if (!back.hasClass('c-hidden'))
			back.addClass('c-hidden');
	}

	_NS.CardComponent.prototype.getChart = function() {
		return this._chart;
	}
}());